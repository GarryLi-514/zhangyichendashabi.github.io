<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cupid's Particle System</title>
    <style>
        :root {
            --primary: #ff69b4; /* HotPink */
            --chaos: #00f3ff;   /* Cyan */
            --glass: rgba(20, 20, 30, 0.6);
        }

        body {
            margin: 0;
            overflow: hidden;
            /* çº¯é»‘èƒŒæ™¯ï¼Œä¿è¯ç²’å­å’Œçˆ±å¿ƒé«˜å¯¹æ¯”åº¦ */
            background-color: #050505;
            font-family: 'Segoe UI', sans-serif;
            color: white;
            user-select: none;
        }

        #canvas-container {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 1;
        }

        /* æ¬¢è¿/å¯åŠ¨é®ç½© */
        #start-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.9);
            z-index: 100;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            transition: opacity 0.8s;
        }

        .start-btn {
            padding: 15px 40px;
            font-size: 24px;
            background: transparent;
            border: 2px solid var(--primary);
            color: var(--primary);
            border-radius: 50px;
            cursor: pointer;
            transition: all 0.3s;
            box-shadow: 0 0 15px rgba(255, 105, 180, 0.3);
            margin-top: 20px;
        }

        .start-btn:hover {
            background: var(--primary);
            color: white;
            box-shadow: 0 0 30px rgba(255, 105, 180, 0.8);
            transform: scale(1.05);
        }

        /* çŠ¶æ€æç¤º UI */
        #ui-layer {
            position: absolute;
            top: 30px;
            width: 100%;
            text-align: center;
            z-index: 10;
            pointer-events: none;
        }

        h1 {
            font-weight: 300;
            letter-spacing: 4px;
            text-shadow: 0 0 10px rgba(255,255,255,0.5);
            margin: 0;
            opacity: 0.8;
            transition: color 0.5s;
        }

        #instruction {
            margin-top: 10px;
            font-size: 14px;
            color: #aaa;
            background: rgba(0,0,0,0.5);
            display: inline-block;
            padding: 8px 20px;
            border-radius: 20px;
            border: 1px solid rgba(255,255,255,0.1);
        }

        /* çˆ±å¿ƒæ£€æµ‹åé¦ˆ */
        .heart-detected-msg {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 40px;
            font-weight: bold;
            color: #fff;
            text-shadow: 0 0 20px var(--primary);
            opacity: 0;
            transition: opacity 0.5s;
            z-index: 5;
            pointer-events: none;
        }
        
        .heart-detected-msg.show {
            opacity: 1;
            /* å…ˆç”¨ pulse åš 2 æ¬¡è·³åŠ¨ï¼ˆ1s * 2ï¼‰ï¼Œå†è¡”æ¥ä¸€æ¬¡æ·¡å‡ºåŠ¨ç”» */
            animation:
                pulse 1s ease-in-out 0s 2,
                fadeOutUp 0.5s ease-in-out 2s 1 forwards;
        }

        /* LOVE DETECTED æ–‡æœ¬å¼¹è·³ */
        @keyframes pulse {
            0% { transform: translate(-50%, -50%) scale(1); }
            50% { transform: translate(-50%, -50%) scale(1.1); }
            100% { transform: translate(-50%, -50%) scale(1); }
        }

        /* LOVE DETECTED æ–‡æœ¬æ·¡å‡ºç¦»åœºåŠ¨ç”» */
        @keyframes fadeOutUp {
            0% {
                opacity: 1;
                transform: translate(-50%, -50%) scale(1);
            }
            100% {
                opacity: 0;
                transform: translate(-50%, -65%) scale(0.9);
            }
        }

        /* ==== æµªæ¼«è£…é¥°å±‚ï¼šæŸ”å…‰æ™• + æ¼‚æµ®å°çˆ±å¿ƒ ==== */
        #romantic-overlay {
            position: fixed;
            inset: 0;
            pointer-events: none;
            z-index: 2; /* åœ¨ç²’å­ä¹‹ä¸Šã€UI ä¹‹ä¸‹ */
            overflow: hidden;
        }

        /* ä¸­å¤®æŸ”å…‰æ™•ï¼Œå¢åŠ æ¢¦å¹»æ„Ÿ */
	    	#romantic-overlay::before {
	    	    content: "";
	    	    position: absolute;
	    	    /* æ‰©å¤§è¦†ç›–èŒƒå›´ï¼Œè®©æŸ”å…‰æ›´å¤§ä¸€äº› */
	    	    inset: -35%;
	    	    background:
	    	        radial-gradient(circle at center,
	    	            /* æé«˜ä¸­å¿ƒäº®åº¦å’ŒèŒƒå›´ï¼Œè®©æŸ”å…‰æ›´æ˜æ˜¾ */
	    	            rgba(255, 182, 193, 0.32) 0%,
	    	            rgba(255, 182, 193, 0.16) 30%,
	    	            transparent 72%);
	    	    mix-blend-mode: screen;
	    	    opacity: 0.95;
	    	}

        .floating-hearts {
            position: absolute;
            inset: 0;
        }

        /* é»˜è®¤ä¸æ’­æ”¾åŠ¨ç”»ï¼Œç­‰å¾…è¿›å…¥ Cupid æ¨¡å¼æ—¶å†æ¿€æ´» */
        .floating-hearts span {
            position: absolute;
            bottom: -10%;
            font-size: 16px;
            color: rgba(255, 192, 203, 0.9);
            text-shadow: 0 0 10px rgba(255, 105, 180, 0.9);
            opacity: 0;
        }

        /* åªæœ‰åœ¨ active çŠ¶æ€ä¸‹æ‰å¼€å§‹ç¼“æ…¢ä¸Šå‡åŠ¨ç”» */
        .floating-hearts.active span {
            animation: floatUp 9s linear infinite;
        }

        .floating-hearts span:nth-child(1)  { left: 8%;  animation-delay: 0s;   animation-duration: 10s; font-size: 18px; }
        .floating-hearts span:nth-child(2)  { left: 20%; animation-delay: 3s;   animation-duration: 11s; font-size: 14px; }
        .floating-hearts span:nth-child(3)  { left: 32%; animation-delay: 1.5s; animation-duration: 9s;  font-size: 20px; }
        .floating-hearts span:nth-child(4)  { left: 44%; animation-delay: 4s;   animation-duration: 10s; font-size: 15px; }
        .floating-hearts span:nth-child(5)  { left: 56%; animation-delay: 2.2s; animation-duration: 12s; font-size: 17px; }
        .floating-hearts span:nth-child(6)  { left: 68%; animation-delay: 5.5s; animation-duration: 9.5s; font-size: 16px; }
        .floating-hearts span:nth-child(7)  { left: 78%; animation-delay: 1s;  animation-duration: 11.5s; font-size: 19px; }
        .floating-hearts span:nth-child(8)  { left: 88%; animation-delay: 6.5s; animation-duration: 10s;  font-size: 15px; }
        .floating-hearts span:nth-child(9)  { left: 26%; animation-delay: 7.2s; animation-duration: 12s;  font-size: 13px; }
        .floating-hearts span:nth-child(10) { left: 62%; animation-delay: 8s;  animation-duration: 9s;   font-size: 21px; }

        @keyframes floatUp {
            0% {
                transform: translateY(0) scale(0.9);
                opacity: 0;
            }
            15% {
                opacity: 0.9;
            }
            60% {
                opacity: 0.9;
            }
            100% {
                transform: translateY(-120vh) scale(1.2);
                opacity: 0;
            }
        }

		    /* è¯­éŸ³ç»“æŸåï¼Œåœ¨å·¦ä¸Šè§’é£˜å…¥çš„å‘Šç™½æ–‡å­— */
		    .love-wish {
		        position: fixed;
		        left: 4vw;
		        top: calc(6vh + 150px);
	        max-width: 46vw;
	        font-size: 20px; /* å­—ä½“ç•¥å¾®æ”¾å¤§ï¼Œæ›´çªå‡ºã€æ›´å”¯ç¾ */
	        line-height: 1.6;
	        color: #ffe2f0;
	        text-align: left;
	        opacity: 0;
	        transform: translate(0, -20px);
	        text-shadow: 0 0 12px rgba(255, 105, 180, 0.7);
	        pointer-events: none;
	        z-index: 11;
	        /* å”¯ç¾ä¸€ç‚¹çš„å­—ä½“ï¼šä¼˜å…ˆæ¥·ä½“/æ‰‹å†™ï¼Œå…¶æ¬¡å®‹ä½“/è¡¬çº¿åšå…œåº• */
	        font-family: "STKaiti", "KaiTi", "FZYaoti", "SimSun", serif;
	    }

	    .love-wish.show {
	        animation: wishFloatIn 2.2s ease-out forwards;
	    }

		    /* å³ä¸‹è§’ç½²åæ–‡å­—æ ·å¼ */
		    .love-signature {
		        position: fixed;
		        right: calc(4vw + 50px);
		        bottom: calc(4vh + 150px);
		        font-size: 20px; /* ä¸å·¦ä¸Šè§’ love-wish å­—å·ä¿æŒä¸€è‡´ */
	        color: rgba(255, 226, 240, 0.95);
	        text-align: right;
	        opacity: 0;
	        transform: translate(20px, 20px);
	        text-shadow: 0 0 10px rgba(255, 105, 180, 0.7);
	        pointer-events: none;
	        z-index: 11;
	        font-family: "STKaiti", "KaiTi", "FZYaoti", "SimSun", serif;
	    }

	    .love-signature.show {
	        animation: wishFloatIn 1.8s ease-out forwards;
	    }

	    @keyframes wishFloatIn {
	        0% {
	            opacity: 0;
	            transform: translate(20px, 20px);
	        }
	        60% {
	            opacity: 1;
	            transform: translate(0, 0);
	        }
	        100% {
	            opacity: 1;
	            transform: translate(0, -6px);
	        }
	    }

        .input_video { display: none; }
    </style>
    
    <!-- ä¾èµ–åº“ -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/control_utils/control_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands/hands.js" crossorigin="anonymous"></script>
</head>
<body>

    <!-- å¯åŠ¨é¡µ -->
    <div id="start-overlay">
        <h2 style="color:white; font-weight: 300;">Web Gesture Experience</h2>
        <div style="color:#888; margin-bottom: 20px;">è¯·å…è®¸æ‘„åƒå¤´æƒé™ â€¢ å¹¶æ‰“å¼€éŸ³é‡</div>
        <button class="start-btn" onclick="startApp()">å¼€å¯æµªæ¼«ä¹‹æ—…</button>
    </div>

	    <!-- ç•Œé¢å±‚ -->
	    <div id="ui-layer">
	        <h1 id="main-title">CHAOS MODE</h1>
	        <div id="instruction">è¯·åœ¨é•œå¤´å‰ç”¨ä¸€åªæ‰‹æ¯”ä¸€ä¸ªå°å¿ƒå¿ƒ ğŸ’– å¹¶ä¿æŒå‡ ç§’</div>
	    </div>

			<!-- è¯­éŸ³ç»“æŸåå·¦ä¸Šè§’ç¼“ç¼“é£˜å…¥çš„å‘Šç™½å¥å­ -->
		<div id="love-wish" class="love-wish">
		    æ‰§å­ä¹‹æ‰‹ï¼Œä¸å­å•è€ï¼Œæ„¿ä¸ä½ å…±åº¦æ¯ä¸€ä¸ªå¹³å‡¡çš„æ—¥å­~
		</div>

		<!-- å³ä¸‹è§’ç½²åæ–‡å­— -->
		<div id="love-signature" class="love-signature">
			    æ—¥æœˆæ˜Ÿè¾°ï¼Œæˆ‘å¿ƒæ°¸æ’
		</div>

    <!-- ä¸­å¿ƒåé¦ˆæ–‡å­— -->
    <div id="heart-msg" class="heart-detected-msg">LOVE DETECTED</div>

    <!-- éšè—è§†é¢‘æº -->
    <video class="input_video"></video>
    
	    <!-- 3D å®¹å™¨ -->
	    <div id="canvas-container"></div>

	    <!-- æµªæ¼«è£…é¥°å±‚ï¼šæŸ”å…‰æ™• + ç¼“æ…¢é£˜åŠ¨çš„å°çˆ±å¿ƒ -->
	    <div id="romantic-overlay">
	        <div class="floating-hearts">
	            <span>â™¥</span>
	            <span>â™¥</span>
	            <span>â™¥</span>
	            <span>â™¥</span>
	            <span>â™¥</span>
	            <span>â™¥</span>
	            <span>â™¥</span>
	            <span>â™¥</span>
	            <span>â™¥</span>
	            <span>â™¥</span>
	        </div>
	    </div>

	    <!-- éŸ³é¢‘èµ„æº (ä½¿ç”¨å…è´¹çš„æµªæ¼«é£æ ¼å¾ªç¯éŸ³ä¹) -->
	    <audio id="bgm" loop>
	        <source src="https://cdn.pixabay.com/download/audio/2022/05/27/audio_1808fbf07a.mp3?filename=romantic-piano-111583.mp3" type="audio/mpeg">
	    </audio>

	    <!-- ä½ çš„è¯­éŸ³ç•™è¨€ï¼ˆç¤ºä¾‹ï¼šè¯·å°† src æ¢æˆä½ è‡ªå·±å½•åˆ¶çš„é‚£æ®µè¯çš„åœ°å€ï¼‰ -->
	    <audio id="voice">
	        <!-- ç¤ºä¾‹å ä½ï¼šè¯·æ›¿æ¢ä¸ºä½ è‡ªå·±çš„è¯­éŸ³æ–‡ä»¶ï¼Œå¦‚ voice.mp3 -->
	        <source src="voice.mp3" type="audio/mpeg">
	    </audio>

<script>
// --- é…ç½® ---
const CONFIG = {
    particleCount: 6000,
    chaosSpeed: 0.2,     // æ··ä¹±æ¨¡å¼ä¸‹çš„é£è¡Œé€Ÿåº¦
    formSpeed: 0.15,      // èšåˆæˆå½¢çš„é€Ÿåº¦
    colors: {
        chaos: new THREE.Color(0x00f3ff), // åˆå§‹é’è‰²
        love: new THREE.Color(0xff69b4)   // çˆ±å¿ƒç²‰è‰²
    }
};

// --- å…¨å±€å˜é‡ ---
let scene, camera, renderer, particles;
let positions, targetPositions, velocities;

// æ‰‹åŠ¿ & æ¨¡å¼çŠ¶æ€
let isHeartGesture = false;      // æ˜¯å¦æ£€æµ‹åˆ°è§¦å‘æ‰‹åŠ¿ï¼ˆæ‹³å¤´ / æ¯”å¿ƒï¼‰
let isCupidActive = false;       // ç²’å­æ˜¯å¦å·²ç»å¼€å§‹æ±‡èšæˆçˆ±å¿ƒ+ç®­çŸ¢
let gestureEnterTime = 0;        // æ£€æµ‹åˆ°æ‰‹åŠ¿çš„æ—¶é—´ï¼ˆä½¿ç”¨ time è®¡æ—¶ï¼‰
let heartAppearTime = 0;         // çˆ±å¿ƒçœŸæ­£æˆå½¢ï¼ˆç²’å­è¿›å…¥ Cupid å½¢æ€ï¼‰çš„æ—¶é—´
let hasStartedAudioForCupid = false; // å½“å‰è¿™ä¸€è½®çˆ±å¿ƒæ˜¯å¦å·²ç»å¯åŠ¨è¿‡éŸ³é¢‘
let wasCupidActive = false;      // ä¸Šä¸€å¸§çš„ Cupid çŠ¶æ€ï¼Œç”¨æ¥åˆ¤æ–­åˆšåˆšè¿›å…¥çˆ±å¿ƒå½¢æ€
let fingerHeartStableFrames = 0; // å•æ‰‹å°å¿ƒå¿ƒå·²è¿ç»­æ£€æµ‹åˆ°çš„å¸§æ•°ï¼Œç”¨äºé™ä½çµæ•åº¦

// æ–‡æ¡ˆä¸çˆ±å¿ƒå‡ºç°èŠ‚å¥ï¼š
// LOVE DETECTED æ–‡æ¡ˆè·³åŠ¨ 2 æ¬¡ï¼ˆçº¦ 2sï¼‰+ æ¶ˆå¤±åŠ¨ç”»ï¼ˆçº¦ 0.5sï¼‰åï¼Œå†å¼€å§‹çˆ±å¿ƒèšåˆ
const LOVE_PULSE_DURATION = 2.0;    // æ–‡å­—è·³åŠ¨æ€»æ—¶é•¿ï¼ˆ2 æ¬¡ pulseï¼‰
const LOVE_FADE_DURATION  = 0.5;    // æ–‡å­—æ¶ˆå¤±åŠ¨ç”»æ—¶é•¿
const CUPID_DELAY         = LOVE_PULSE_DURATION + LOVE_FADE_DURATION; // â‰ˆ2.5s åå¼€å§‹èšåˆ
const FINGER_HEART_MIN_FRAMES = 5;  // è‡³å°‘è¿ç»­ N å¸§éƒ½æ£€æµ‹åˆ°å°å¿ƒå¿ƒï¼Œæ‰è®¤ä¸ºçœŸæ­£è§¦å‘ï¼ˆå†æ”¾å®½ä¸€ç‚¹ï¼‰

let mode = 'chaos'; // é¢„ç•™ï¼š'chaos' or 'love'ï¼ˆå½“å‰æœªç›´æ¥ä½¿ç”¨ï¼‰
let time = 0;
let audio;      // èƒŒæ™¯å¾ªç¯ BGM
let voiceAudio; // ä½ æƒ³è¯´çš„é‚£æ®µè¯çš„éŸ³é¢‘

	// --- å½¢çŠ¶ç”Ÿæˆå™¨ ---
	const ShapeGenerator = {
	    // æ··ä¹±çŠ¶æ€ï¼šéšæœºåˆ†å¸ƒåœ¨å±å¹•ç©ºé—´
	    chaos: () => {
	        return {
	            x: (Math.random() - 0.5) * 60,
	            y: (Math.random() - 0.5) * 40,
	            z: (Math.random() - 0.5) * 40
	        };
	    },
	    // ä¸˜æ¯”ç‰¹ä¹‹ç®­ï¼šçˆ±å¿ƒ + ç®­çŸ¢
	    cupid: (index, total) => {
	        // å‰ 65% çš„ç²’å­ç»„æˆçˆ±å¿ƒ
	        if (index < total * 0.65) {
	            // å‚æ•°åŒ–çˆ±å¿ƒ
	            let t = Math.random() * Math.PI * 2;
	            // å¢åŠ ä¸€ç‚¹åšåº¦
	            let r = 0.5 + Math.random() * 0.5;

	            let x = 16 * Math.pow(Math.sin(t), 3);
	            let y = 13 * Math.cos(t) - 5 * Math.cos(2*t) - 2 * Math.cos(3*t) - Math.cos(4*t);
	            let z = (Math.random() - 0.5) * 5;

	            // å¿ƒå½¢æ”¾å¤§ï¼šç¼©æ”¾ç³»æ•°ä»0.5æ”¹ä¸º0.75
	            return { x: x * 0.75, y: y * 0.75 + 3, z: z };
	        }
	        // å 35% çš„ç²’å­ç»„æˆç®­
	        else {
	            const arrowRatio = (index - total * 0.65) / (total * 0.35); // 0 åˆ° 1

	        	// ç®­åŸºäºæ°´å¹³æ–¹å‘é€†æ—¶é’ˆæ—‹è½¬çº¦ 15Â°ï¼Œä»å·¦ä¸‹ç•¥å¾®ä¸Šæ‰¬ç©¿è¿‡çˆ±å¿ƒ
	        	// ä»¥ (0, 1.5) ä¸ºå¤§è‡´ä¸­å¿ƒåšæ—‹è½¬ï¼Œä¿è¯ç©¿å¿ƒæ•ˆæœ
	        	const start = {x: -29.0, y: -6.3, z: 0};
	        	const end   = {x:  29.0, y:  9.3, z: 0};

	            // æ„å»ºæ²¿ç®­èº«å’Œå‚ç›´æ–¹å‘çš„å±€éƒ¨åæ ‡ç³»
	            const dx = end.x - start.x;
	            const dy = end.y - start.y;
	            const len = Math.sqrt(dx * dx + dy * dy);
	            const dir = { x: dx / len, y: dy / len };              // æ²¿ç®­èº«æ–¹å‘çš„å•ä½å‘é‡
	            const perp = { x: -dir.y, y: dir.x };                  // åœ¨å±å¹•å¹³é¢å†…ã€å‚ç›´äºç®­èº«

	            // ç»Ÿä¸€çš„å‚æ•°
	            const headLength = 10;   // ç®­å¤´å®é™…é•¿åº¦ï¼ˆä¸–ç•Œåæ ‡ï¼‰
	            const headWidth  = 6;    // ç®­å¤´åº•éƒ¨æ€»å®½åº¦
	            const featherLength = 7; // ç®­å°¾æ€»é•¿åº¦
	            const featherWidth  = 4; // ç®­å°¾æœ€å¤§å®½åº¦

	            let x, y, z;

	            // ===== ç®­å°¾ï¼šè§„åˆ™æ¥”å½¢å°¾ç¿¼ (0 - 0.25) =====
	            if (arrowRatio < 0.25) {
	                // sï¼šæ²¿ç®­èº«æ–¹å‘çš„è·ç¦»ï¼ˆä»ç®­å°¾å‘åä¸ºè´Ÿå€¼ï¼‰
	                const s = -Math.random() * featherLength; // [ -featherLength , 0 ]
	                const absS = -s;
	                // å°¾ç¿¼å®½åº¦éšç¦»å¼€ç®­èº«è¶Šè¿œè¶Šå¤§ï¼Œå½¢æˆæ¥”å½¢
	                const maxHalfWidth = featherWidth * (0.3 + 0.7 * (absS / featherLength));
	                const tOffset = (Math.random() - 0.5) * 2 * maxHalfWidth; // [-maxHalfWidth, maxHalfWidth]

	                x = start.x + dir.x * s + perp.x * tOffset;
	                y = start.y + dir.y * s + perp.y * tOffset;
	                z = (Math.random() - 0.5) * 1.0;
	            }
	            // ===== ç®­æ†ï¼šç»†ç›´çº¿ (0.25 - 0.75) =====
	            else if (arrowRatio < 0.75) {
	                // sï¼šæ²¿ç®­èº«çš„è·ç¦»ï¼ˆä» start å¼€å§‹ï¼Œ0 åœ¨ç®­å°¾ï¼Œä¸ç®­å°¾/ç®­å¤´ç•¥å¾®é‡å ï¼Œé¿å…å‡ºç°ç¼éš™ï¼‰
	                const baseHeadS   = len - headLength; // ç®­å¤´åº•è¾¹æ‰€åœ¨çš„ä½ç½®
	                const shaftStartS = -0.3;            // ç•¥å¾®è¿›å…¥ç¾½æ¯›åŒºåŸŸ
	                const shaftEndS   = baseHeadS + 0.3; // ç•¥å¾®è¿›å…¥ç®­å¤´åŒºåŸŸ
	                const s = shaftStartS + Math.random() * (shaftEndS - shaftStartS);

	                const radius = 0.4;                  // ç®­æ†ç²—ç»†
	                const tOffset = (Math.random() - 0.5) * 2 * radius;

	                x = start.x + dir.x * s + perp.x * tOffset;
	                y = start.y + dir.y * s + perp.y * tOffset;
	                z = (Math.random() - 0.5) * 0.8;
	            }
	            // ===== ç®­å¤´ï¼šæ ‡å‡†ç­‰è…°ä¸‰è§’å½¢ (0.75 - 1.0) =====
	            else {
	                // ä»ç®­å¤´å°–ç«¯å‘åé‡ sHeadï¼Œ0 åœ¨å°–ç«¯ï¼ŒheadLength åœ¨åº•è¾¹
	                const sHead = Math.random() * headLength; // [0, headLength]
	                // åœ¨è¯¥æˆªé¢ä¸Šçš„å…è®¸åŠå®½åº¦ï¼šè¶Šé è¿‘åº•è¾¹è¶Šå®½ï¼Œå°–ç«¯ä¸º 0
	                const halfWidth = (sHead / headLength) * (headWidth / 2);
	                const tOffset = (Math.random() - 0.5) * 2 * halfWidth;

	                // å°–ç«¯åœ¨ end å¤„ï¼Œå‘åæ²¿ dir æ–¹å‘å‡å» sHead
	                x = end.x - dir.x * sHead + perp.x * tOffset;
	                y = end.y - dir.y * sHead + perp.y * tOffset;
	                z = (Math.random() - 0.5) * 1.2;
	            }

	            // è½»å¾®æŠ–åŠ¨ï¼Œä¿æŒå½¢çŠ¶æ¸…æ™°
	            x += (Math.random() - 0.5) * 0.05;
	            y += (Math.random() - 0.5) * 0.05;
	            z += (Math.random() - 0.5) * 0.05;

	            return { x, y, z };
	        }
	    }
	};

// --- Three.js åˆå§‹åŒ– ---
function initThree() {
    const container = document.getElementById('canvas-container');
    scene = new THREE.Scene();
    // å¢åŠ ä¸€ç‚¹ç¯å¢ƒé›¾ï¼Œå¢å¼ºæ·±åº¦æ„Ÿ
    scene.fog = new THREE.FogExp2(0x050505, 0.02);

    camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
    camera.position.z = 35;

    renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
    renderer.setSize(window.innerWidth, window.innerHeight);
    renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));
    container.appendChild(renderer.domElement);

    // åˆ›å»ºç²’å­
    const geometry = new THREE.BufferGeometry();
    positions = new Float32Array(CONFIG.particleCount * 3);
    targetPositions = new Float32Array(CONFIG.particleCount * 3);
    velocities = [];

    // åˆå§‹åŒ–ï¼šæ‰€æœ‰ç²’å­éšæœºåˆ†å¸ƒï¼ˆChaosæ¨¡å¼ï¼‰
    for(let i = 0; i < CONFIG.particleCount; i++) {
        const p = ShapeGenerator.chaos();
        positions[i*3] = p.x;
        positions[i*3+1] = p.y;
        positions[i*3+2] = p.z;
        
        // èµ‹äºˆåˆå§‹éšæœºé€Ÿåº¦
        velocities.push({
            x: (Math.random() - 0.5) * 0.1,
            y: (Math.random() - 0.5) * 0.1,
            z: (Math.random() - 0.5) * 0.1
        });

        // é¢„è®¡ç®— Cupid å½¢çŠ¶çš„ç›®æ ‡ä½ç½®
        const t = ShapeGenerator.cupid(i, CONFIG.particleCount);
        targetPositions[i*3] = t.x;
        targetPositions[i*3+1] = t.y;
        targetPositions[i*3+2] = t.z;
    }

    geometry.setAttribute('position', new THREE.BufferAttribute(positions, 3));

    const material = new THREE.PointsMaterial({
        size: 0.3,
        color: CONFIG.colors.chaos,
        transparent: true,
        opacity: 0.8,
        blending: THREE.AdditiveBlending,
        depthWrite: false
    });

    particles = new THREE.Points(geometry, material);
    scene.add(particles);

    window.addEventListener('resize', () => {
        camera.aspect = window.innerWidth / window.innerHeight;
        camera.updateProjectionMatrix();
        renderer.setSize(window.innerWidth, window.innerHeight);
    });
}

// --- åŠ¨ç”»å¾ªç¯ ---
function animate() {
	requestAnimationFrame(animate);
	time += 0.01;

		// æ‰‹åŠ¿æ£€æµ‹åˆ°åï¼Œå…ˆåªå±•ç¤º LOVE DETECTEDï¼Œç¨ä½œåœé¡¿å†å¼€å§‹ç²’å­æ±‡èš
		if (isHeartGesture) {
		    // ä½¿ç”¨ time ä½œä¸ºç®€å•çš„æ—¶é—´è½´ï¼Œè¶…è¿‡å»¶è¿Ÿåæ‰çœŸæ­£è¿›å…¥ Cupid å½¢æ€
		    if (!isCupidActive && (time - gestureEnterTime >= CUPID_DELAY)) {
		        isCupidActive = true;
		    }
		} else {
		    isCupidActive = false;
		}

		// è®°å½•â€œåˆšåˆšè¿›å…¥çˆ±å¿ƒå½¢æ€â€çš„æ—¶é—´ç‚¹ï¼Œç”¨äº 1 ç§’åå†å¯åŠ¨éŸ³é¢‘
		if (isCupidActive && !wasCupidActive) {
		    heartAppearTime = time;
		    hasStartedAudioForCupid = false;
		}
		// çˆ±å¿ƒå·²ç»å‡ºç°ï¼Œä¸”å°šæœªä¸ºè¿™ä¸€è½®å¯åŠ¨è¿‡éŸ³é¢‘ï¼šåœ¨å‡ºç° 1 ç§’åå†ç»Ÿä¸€å¯åŠ¨ BGM + è¯­éŸ³
		if (isCupidActive && !hasStartedAudioForCupid && heartAppearTime > 0 && (time - heartAppearTime) >= 1.0) {
		    fadeInAudio();
		    playVoiceMessage();
		    hasStartedAudioForCupid = true;
		}
		// è®°å½•å½“å‰å¸§ Cupid çŠ¶æ€
		wasCupidActive = isCupidActive;

	const positionsArray = particles.geometry.attributes.position.array;
	
	// é¢œè‰²å¹³æ»‘è¿‡æ¸¡ï¼šä»…åœ¨çœŸæ­£è¿›å…¥ Cupid å½¢æ€åå†å˜ä¸ºç²‰è‰²
	const targetColor = isCupidActive ? CONFIG.colors.love : CONFIG.colors.chaos;
	particles.material.color.lerp(targetColor, 0.05);

	// æ—‹è½¬åœºæ™¯
	particles.rotation.y = Math.sin(time * 0.2) * 0.1;

	for (let i = 0; i < CONFIG.particleCount; i++) {
        const idx = i * 3;
        let px = positionsArray[idx];
        let py = positionsArray[idx+1];
        let pz = positionsArray[idx+2];

	    if (isCupidActive) {
	        // --- æ¨¡å¼ï¼šæ±‡èšæˆçˆ±å¿ƒ ---
            const tx = targetPositions[idx];
            const ty = targetPositions[idx+1];
            const tz = targetPositions[idx+2];

            // å¼ºå¼•åŠ›é£å‘ç›®æ ‡
            px += (tx - px) * CONFIG.formSpeed;
            py += (ty - py) * CONFIG.formSpeed;
            pz += (tz - pz) * CONFIG.formSpeed;

            // æ·»åŠ å¾®å°çš„æŠ–åŠ¨ï¼ˆè®©çˆ±å¿ƒçœ‹èµ·æ¥åœ¨é—ªçƒ/æ´»ç€ï¼‰
            px += (Math.random() - 0.5) * 0.05;
            py += (Math.random() - 0.5) * 0.05;
            pz += (Math.random() - 0.5) * 0.05;

        } else {
            // --- æ¨¡å¼ï¼šæ··æ²Œé£èˆ ---
            // ä½¿ç”¨ Curl Noise æˆ– ç®€å•çš„æ­£å¼¦æ³¢å™ªç‚¹æ¨¡æ‹Ÿå¸ƒæœ—è¿åŠ¨
            const vx = velocities[i].x + Math.sin(py * 0.1 + time) * 0.02;
            const vy = velocities[i].y + Math.cos(pz * 0.1 + time) * 0.02;
            const vz = velocities[i].z + Math.sin(px * 0.1 + time) * 0.02;

            px += vx;
            py += vy;
            pz += vz;

            // è¾¹ç•Œæ£€æŸ¥ï¼šé£å¤ªè¿œå°±ç¬ç§»åˆ°å¦ä¸€è¾¹ï¼ˆæ— é™ç©ºé—´é”™è§‰ï¼‰
            if (px > 50) px = -50; if (px < -50) px = 50;
            if (py > 30) py = -30; if (py < -30) py = 30;
            if (pz > 30) pz = -30; if (pz < -30) pz = 30;
        }

        positionsArray[idx] = px;
        positionsArray[idx+1] = py;
        positionsArray[idx+2] = pz;
    }

    particles.geometry.attributes.position.needsUpdate = true;
    renderer.render(scene, camera);
}

// --- æ‰‹åŠ¿è¯†åˆ«é€»è¾‘ ---
// [å¤‡ç”¨] æ‹³å¤´æ£€æµ‹ - æ–¹ä¾¿ä»¥ååˆ‡å›æµ‹è¯•ç”¨
function checkFistGesture(landmarks) {
    // å…³é”®ç‚¹ï¼šæ‰‹è…•(0), å„æŒ‡å°–(4,8,12,16,20), å„æŒ‡æ ¹MCP(5,9,13,17)
    const fingertips = [landmarks[4], landmarks[8], landmarks[12], landmarks[16], landmarks[20]];
    const mcps = [landmarks[5], landmarks[9], landmarks[13], landmarks[17]];

    // è®¡ç®—æ‰‹æŒä¸­å¿ƒï¼ˆç”¨MCPå…³èŠ‚çš„å¹³å‡ä½ç½®ï¼‰
    const palmCenter = {
        x: (mcps[0].x + mcps[1].x + mcps[2].x + mcps[3].x) / 4,
        y: (mcps[0].y + mcps[1].y + mcps[2].y + mcps[3].y) / 4,
        z: (mcps[0].z + mcps[1].z + mcps[2].z + mcps[3].z) / 4
    };

    // æ£€æŸ¥æ‰€æœ‰æŒ‡å°–æ˜¯å¦é è¿‘æ‰‹æŒä¸­å¿ƒï¼ˆæ¡æ‹³çŠ¶æ€ï¼‰
    let closedFingers = 0;
    const threshold = 0.1; // æŒ‡å°–åˆ°æ‰‹æŒä¸­å¿ƒçš„è·ç¦»é˜ˆå€¼

    for (let tip of fingertips) {
        const dist = Math.hypot(tip.x - palmCenter.x, tip.y - palmCenter.y, tip.z - palmCenter.z);
        if (dist < threshold) {
            closedFingers++;
        }
    }

    // è‡³å°‘4ä¸ªæ‰‹æŒ‡æ¡ç´§åˆ¤å®šä¸ºæ‹³å¤´
    return closedFingers >= 4;
}

// å•æ‰‹å°å¿ƒå¿ƒæ‰‹åŠ¿æ£€æµ‹ï¼šåªä¼¸å‡ºé£ŸæŒ‡ï¼Œæ‹‡æŒ‡æ¨ªå‘è´´è¿‘é£ŸæŒ‡ï¼Œå…¶å®ƒä¸‰æŒ‡æ”¶èµ·
// è¿™ä¸€ç‰ˆå°½é‡å’Œä½ å‘çš„ç…§ç‰‡ä¸€è‡´ï¼Œå¹¶ä¸”å¯¹æ‰‹çš„æœå‘ä¸æ•æ„Ÿï¼ˆä¸ç”¨ä¸¥æ ¼çœ‹ y è½´æ–¹å‘ï¼‰
function checkFingerHeartGesture(landmarks) {
	const wrist = landmarks[0];

	// æ‹‡æŒ‡
	const thumbCmc = landmarks[1];
	const thumbMcp = landmarks[2];
	const thumbIp  = landmarks[3];
	const thumbTip = landmarks[4];

	// é£ŸæŒ‡
	const indexMcp = landmarks[5];
	const indexPip = landmarks[6];
	const indexDip = landmarks[7];
	const indexTip = landmarks[8];

	// ä¸­æŒ‡
	const middleMcp = landmarks[9];
	const middlePip = landmarks[10];
	const middleDip = landmarks[11];
	const middleTip = landmarks[12];

	// æ— åæŒ‡
	const ringMcp = landmarks[13];
	const ringPip = landmarks[14];
	const ringDip = landmarks[15];
	const ringTip = landmarks[16];

	// å°æŒ‡
	const pinkyMcp = landmarks[17];
	const pinkyPip = landmarks[18];
	const pinkyDip = landmarks[19];
	const pinkyTip = landmarks[20];

	function dist(a, b) {
	    return Math.hypot(a.x - b.x, a.y - b.y, a.z - b.z);
	}

	// ä¼°ç®—æ‰‹æŒå°ºå¯¸ï¼Œç”¨äºåšâ€œè‡ªé€‚åº”é˜ˆå€¼â€
	const palmSize = dist(wrist, middleMcp) || 0.15;

	// åˆ¤æ–­ä¸€æ ¹æ‰‹æŒ‡æ˜¯å¦â€œä¼¸ç›´ & ä¼¸å‡ºâ€â€”â€”ä¸æ‘„åƒå¤´æœå‘æ— å…³
	function isFingerExtended(mcp, pip, dip, tip) {
	    const d1 = dist(mcp, pip);
	    const d2 = dist(pip, dip);
	    const d3 = dist(dip, tip);
	    const pathLen   = d1 + d2 + d3;        // å…³èŠ‚è¿çº¿é•¿åº¦
	    const directLen = dist(mcp, tip);      // MCP åˆ°æŒ‡å°–çš„ç›´çº¿é•¿åº¦
	    if (pathLen === 0) return false;
	    const straightRatio = directLen / pathLen; // è¶Šæ¥è¿‘ 1 è¶Šç¬”ç›´
	    return (straightRatio > 0.8 && directLen > palmSize * 0.45);
	}

	// åˆ¤æ–­ä¸€æ ¹æ‰‹æŒ‡æ˜¯å¦â€œæ˜æ˜¾æ²¡ä¼¸ç›´â€ï¼ˆå·åœ¨æŒå¿ƒé™„è¿‘ï¼‰
	function isFingerFolded(mcp, pip, dip, tip) {
	    const d1 = dist(mcp, pip);
	    const d2 = dist(pip, dip);
	    const d3 = dist(dip, tip);
	    const pathLen   = d1 + d2 + d3;
	    const directLen = dist(mcp, tip);
	    if (pathLen === 0) return false;
	    const straightRatio = directLen / pathLen;
	    // åˆçŸ­åˆå¼¯ï¼ŒåŸºæœ¬å°±æ˜¯â€œæ”¶èµ·â€çš„çŠ¶æ€
	    return (straightRatio < 0.75 || directLen < palmSize * 0.4);
	}

	// 1ï¼‰åªæœ‰é£ŸæŒ‡æ˜¯â€œæ˜æ˜¾ä¼¸å‡ºâ€çš„
	const indexExtended = isFingerExtended(indexMcp, indexPip, indexDip, indexTip);
	if (!indexExtended) return false;

	const middleExtended = isFingerExtended(middleMcp, middlePip, middleDip, middleTip);
	const ringExtended   = isFingerExtended(ringMcp, ringPip, ringDip, ringTip);
	const pinkyExtended  = isFingerExtended(pinkyMcp, pinkyPip, pinkyDip, pinkyTip);
	// å…¶å®ƒä¸‰æŒ‡ä¸èƒ½åŒæ—¶æ˜¯â€œä¼¸ç›´çŠ¶æ€â€ï¼Œè‡³å°‘è¦æœ‰ä¸¤æ ¹å¤„äºæŠ˜å /åŠæŠ˜å 
	const foldedFlags = [
	    isFingerFolded(middleMcp, middlePip, middleDip, middleTip),
	    isFingerFolded(ringMcp,   ringPip,   ringDip,   ringTip),
	    isFingerFolded(pinkyMcp,  pinkyPip,  pinkyDip,  pinkyTip)
	];
	const foldedCount = foldedFlags.filter(Boolean).length;
	if (middleExtended || ringExtended || pinkyExtended || foldedCount < 2) {
	    return false;
	}

	// 2ï¼‰æ‹‡æŒ‡æŒ‡å°–è¦é è¿‘é£ŸæŒ‡æŒ‡å°–ï¼ˆå½¢æˆå°å¿ƒå¿ƒçš„å°–ï¼‰
	const thumbIndexDist = dist(thumbTip, indexTip);
	if (thumbIndexDist > palmSize * 0.6) return false;

	// æ¡ä»¶å…¨éƒ¨æ»¡è¶³ï¼Œè®¤ä¸ºæ˜¯å•æ‰‹å°å¿ƒå¿ƒ
	return true;
}

/* [åŸç‰ˆ] æ¯”å¿ƒæ‰‹åŠ¿æ£€æµ‹ - å¼€å‘å®Œæˆåæ¢å¤ä½¿ç”¨
function checkHeartGesture(landmarks1, landmarks2) {
    const t1 = landmarks1[4];
    const i1 = landmarks1[8];
    const t2 = landmarks2[4];
    const i2 = landmarks2[8];
    const thumbDist = Math.hypot(t1.x - t2.x, t1.y - t2.y, t1.z - t2.z);
    const indexDist = Math.hypot(i1.x - i2.x, i1.y - i2.y, i1.z - i2.z);
    const threshold = 0.08;
    return (thumbDist < threshold && indexDist < threshold);
}
*/

function onResults(results) {
	    let detected = false;
	    let currentDetected = false;

	    // å•æ‰‹å°å¿ƒå¿ƒæ‰‹åŠ¿æ£€æµ‹ï¼ˆæ‹‡æŒ‡ä¸é£ŸæŒ‡æŒ‡å°–äº¤å‰/è´´è¿‘ï¼‰
	    if (results.multiHandLandmarks && results.multiHandLandmarks.length >= 1) {
	        for (let hand of results.multiHandLandmarks) {
	            if (checkFingerHeartGesture(hand)) {
	                currentDetected = true;
	                break;
	            }
	        }
	    }

	    // éœ€è¦è¿ç»­å¤šå¸§éƒ½æ£€æµ‹åˆ°å°å¿ƒå¿ƒï¼Œæ‰è®¤ä¸ºçœŸæ­£â€œæ£€æµ‹åˆ°æ‰‹åŠ¿â€
	    if (currentDetected) {
	        fingerHeartStableFrames++;
	    } else {
	        fingerHeartStableFrames = 0;
	    }
	    if (fingerHeartStableFrames >= FINGER_HEART_MIN_FRAMES) {
	        detected = true;
	    }

    /* [åŸç‰ˆ] åŒæ‰‹æ¯”å¿ƒæ£€æµ‹ - å¼€å‘å®Œæˆåæ¢å¤ä½¿ç”¨
    if (results.multiHandLandmarks && results.multiHandLandmarks.length === 2) {
        const hand1 = results.multiHandLandmarks[0];
        const hand2 = results.multiHandLandmarks[1];
        if (checkHeartGesture(hand1, hand2)) {
            detected = true;
        }
    }
    */

	// çŠ¶æ€åˆ‡æ¢å¤„ç†
	if (detected && !isHeartGesture) {
		// é¦–å…ˆä»…è®°å½•â€œæ‰‹åŠ¿å·²å‡ºç°â€ï¼Œå¹¶æ˜¾ç¤º LOVE DETECTEDï¼Œä½†æš‚ä¸ç«‹åˆ»å¼€å§‹ç²’å­æ±‡èšå’Œæ’­æ”¾éŸ³é¢‘
		isHeartGesture = true;
		gestureEnterTime = time;   // è®°å½•å½“å‰æ—¶é—´ï¼Œç”¨äºåŠ¨ç”»å¾ªç¯ä¸­å»¶è¿Ÿè§¦å‘ Cupid å½¢æ€
		isCupidActive = false;     // ç­‰å¾…åŠ¨ç”»å¾ªç¯ä¸­çš„å»¶è¿Ÿåˆ¤æ–­
		heartAppearTime = 0;       // å½“å‰è¿™ä¸€è½®è¿˜æ²¡æœ‰çœŸæ­£æˆå½¢çš„çˆ±å¿ƒ
		hasStartedAudioForCupid = false; // å½“å‰è¿™ä¸€è½®è¿˜æœªå¯åŠ¨éŸ³é¢‘
		updateUI(true);            // æ˜¾ç¤ºå­—å¹• LOVE DETECTED
			// æ–°ä¸€è½®æ£€æµ‹åˆ°æ‰‹åŠ¿æ—¶ï¼Œå…ˆæŠŠä¸Šä¸€è½®çš„å‘Šç™½æ–‡æ¡ˆå’Œç½²åéšè—ï¼Œæ–¹ä¾¿ä¹‹åå†æ¬¡æ’­æ”¾éŸ³é¢‘æ—¶é‡æ–°â€œé£˜å…¥â€
			const wishEl = document.getElementById('love-wish');
			if (wishEl) wishEl.classList.remove('show');
			const signEl = document.getElementById('love-signature');
			if (signEl) signEl.classList.remove('show');
		} else if (!detected && isHeartGesture) {
			// æ‰‹åŠ¿æ¶ˆå¤±ï¼šç«‹åˆ»è¿”å›æ··æ²Œï¼Œå¹¶**ç«‹å³ä¸­æ–­**æ‰€æœ‰éŸ³é¢‘æ’­æ”¾ï¼Œä¹Ÿè®©å‘Šç™½æ–‡å­—å’Œç½²åä¸€èµ·æ¶ˆå¤±
			isHeartGesture = false;
			isCupidActive = false;     // ç«‹åˆ»å›åˆ°æ··æ²Œç‰©ç†çŠ¶æ€
			updateUI(false);
			stopAllAudioImmediate();
			// å¦‚æœå‘Šç™½æ–‡å­—å’Œç½²åå·²ç»å‡ºç°ï¼Œæ­¤æ—¶ä¹Ÿè¦ä¸€èµ·éšè—
			const wishEl2 = document.getElementById('love-wish');
			if (wishEl2) wishEl2.classList.remove('show');
			const signEl2 = document.getElementById('love-signature');
			if (signEl2) signEl2.classList.remove('show');
		}
}

// --- éŸ³é¢‘ä¸ UI ---
function updateUI(isLove) {
    const title = document.getElementById('main-title');
	    const msg = document.getElementById('heart-msg');
	    const heartsLayer = document.querySelector('.floating-hearts');
    
    if (isLove) {
        title.innerText = "CUPID MODE";
        title.style.color = "var(--primary)";
        msg.classList.add('show');
	        // è¿›å…¥ä¸˜æ¯”ç‰¹çŠ¶æ€ï¼šå¯åŠ¨å‰æ™¯æ¼‚æµ®å°çˆ±å¿ƒ
	        if (heartsLayer) heartsLayer.classList.add('active');
    } else {
        title.innerText = "CHAOS MODE";
        title.style.color = "var(--chaos)";
        msg.classList.remove('show');
	        // è¿”å›æ··æ²Œï¼šå…³é—­å‰æ™¯æ¼‚æµ®å°çˆ±å¿ƒ
	        if (heartsLayer) heartsLayer.classList.remove('active');
    }
}

function startApp() {
    document.getElementById('start-overlay').style.opacity = 0;
    setTimeout(() => {
        document.getElementById('start-overlay').style.display = 'none';
    }, 800);

    // åˆå§‹åŒ–éŸ³é¢‘
    audio = document.getElementById('bgm');
    audio.volume = 0;
    // é¢„æ’­æ”¾å¹¶æš‚åœï¼Œç¡®ä¿ä¸Šä¸‹æ–‡æ¿€æ´»
    audio.play().then(() => {
        audio.pause();
    }).catch(e => console.log("Audio waiting for interaction"));

		    // è¯­éŸ³ç•™è¨€éŸ³é¢‘ï¼šåªéœ€è¦æ‹¿åˆ°å¼•ç”¨å³å¯ï¼Œåé¢æ ¹æ®æ‰‹åŠ¿å†æ’­æ”¾
		    voiceAudio = document.getElementById('voice');
		    if (voiceAudio) {
		        voiceAudio.volume = 1.0; // ä½ å¯ä»¥æŒ‰éœ€è¦è°ƒå°ä¸€ç‚¹ï¼Œä¾‹å¦‚ 0.9
		        // å½“è¯­éŸ³è‡ªç„¶æ’­æ”¾ç»“æŸæ—¶ï¼Œåœ¨å±å¹•å·¦ä¸Šè§’ç¼“ç¼“å‡ºç°å‘Šç™½æ–‡æ¡ˆï¼Œå³ä¸‹è§’å‡ºç°ç½²å
		        voiceAudio.addEventListener('ended', () => {
		            const wishEl = document.getElementById('love-wish');
		            if (wishEl) {
		                wishEl.classList.add('show');
		            }
		            const signEl = document.getElementById('love-signature');
		            if (signEl) {
		                signEl.classList.add('show');
		            }
		        });
		    }

    // å¯åŠ¨ç³»ç»Ÿ
    initThree();
    initMediaPipe();
    animate();
}

function fadeInAudio() {
    if(!audio) return;
    audio.play();
    let vol = audio.volume;
    const interval = setInterval(() => {
        if (vol < 0.8) {
            vol += 0.05;
            audio.volume = Math.min(vol, 1);
        } else {
            clearInterval(interval);
        }
    }, 100);
}

function fadeOutAudio() {
    if(!audio) return;
    let vol = audio.volume;
    const interval = setInterval(() => {
        if (vol > 0.05) {
            vol -= 0.05;
            audio.volume = Math.max(vol, 0);
        } else {
            audio.pause();
            clearInterval(interval);
        }
    }, 100);
}

// æ’­æ”¾ä½ æƒ³è¯´çš„é‚£æ®µè¯ï¼ˆå åŠ åœ¨èƒŒæ™¯éŸ³ä¹ä¹‹ä¸Šï¼‰
function playVoiceMessage() {
    if (!voiceAudio) return;
    try {
        // æ¯æ¬¡è§¦å‘æ—¶éƒ½ä»å¤´å¼€å§‹æ’­æ”¾ï¼Œé¿å…å‰ä¸€æ¬¡å‰©ä½™ä½ç½®
        voiceAudio.currentTime = 0;
        voiceAudio.play().catch(err => {
            console.log('Voice message play was blocked:', err);
        });
    } catch (e) {
        console.log('Voice message error:', e);
    }
}

// ç«‹å³ä¸­æ–­æ‰€æœ‰éŸ³é¢‘æ’­æ”¾ï¼ˆç”¨äºæ‰‹åŠ¿æ¾å¼€æ—¶ç«‹åˆ»é™éŸ³ï¼‰
function stopAllAudioImmediate() {
    try {
        if (audio) {
            audio.pause();
            audio.currentTime = 0;
        }
        if (voiceAudio) {
            voiceAudio.pause();
            voiceAudio.currentTime = 0;
        }
    } catch (e) {
        console.log('Audio stop error:', e);
    }
}

// --- MediaPipe åˆå§‹åŒ– ---
function initMediaPipe() {
    const videoElement = document.querySelector('.input_video');
    
    const hands = new Hands({locateFile: (file) => {
        return `https://cdn.jsdelivr.net/npm/@mediapipe/hands/${file}`;
    }});

    // å…³é”®ï¼šè®¾ç½®æ£€æµ‹ä¸¤åªæ‰‹
    hands.setOptions({
        maxNumHands: 2, 
        modelComplexity: 1,
        minDetectionConfidence: 0.5,
        minTrackingConfidence: 0.5
    });

    hands.onResults(onResults);

    const cameraUtils = new Camera(videoElement, {
        onFrame: async () => {
            await hands.send({image: videoElement});
        },
        width: 640,
        height: 480
    });

    cameraUtils.start();
}
</script>
</body>
</html>